{% comment %}

{% if object.pk %}
	<iframe class="iframe{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}" src="http://webchat.freenode.net?nick={{user.username}}&channels=oa-{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}&prompt=1&uio=d4" width="100%" height="{% include 'stream/stream_height.html' %}"></iframe>
{% else %}
	<iframe class="iframe{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}" src="http://webchat.freenode.net?nick={{user.username}}&channels=oa-welcome-aboard&prompt=1&uio=d4" width="100%" height="{% include 'stream/stream_height.html' %}"></iframe>
{% endif %}

{% endcomment %}
<script src="http://{{settings.NODEJS_HOST}}:{{settings.NODEJS_PORT}}/socket.io/socket.io.js"></script>

<script>
		var timestamp = new Date();
		var delta;
		//new socket for this chat session

		function EvalSound(soundobj) {
		  var thissound=document.getElementById(soundobj);
		  thissound.src = '/static/sounds/tabla.wav'
		  thissound.play();
		}

		function scrollBack{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}(){
			//console.log($('#panel_inner{{dashobj.pk}}')._scrollable());
			$('#panel_inner{{dashobj.pk}}').scrollTo('max');
		};

        function disconnect{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}(){
        	//socket.disconnect();
        }
        //WEBSOCKETS SETUP        

		// on load of page
		$(function(){

            {% if user.is_authenticated %}
            	socket.emit('adduser', '{{user.username}}', '{{request.session.session_key}}', '{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}');
            {% else %}
            {% pp_random_id slice=5 %}
               socket.emit('adduser', 'guest{{pp_tag.id}}', '{{request.session.session_key}}', '{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}');
            {% endpp_random_id %}
            {% endif %}


			// when the client clicks SEND
			$('#datasend{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').click( function() {
				var message = $('#data{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').val();
				$('#data{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').val('');
				// tell server to execute 'sendchat' and send along one parameter
				socket.emit('sendchat', message, '{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}');
				$('#data{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').focus();

			});

			// when the client hits ENTER on their keyboard
			$('#data{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').keypress(function(e) {
				if(e.which == 13) {
					$(this).blur();
					$('#datasend{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}').focus().click();
				}
			});


			//this dynamic javascript produced by the django template basically gives us access to the dashobj function
			//which is user specific, however the socket.io JS is global and cannot access the django templates outside of connect
			//as it is overwritten when multiple chat windows are open
			

        });



</script>

<audio id="audio1" src="/static/sounds/tabla.wav" preload="auto" autobuffer>
</audio>

<div style="float:left;width:80%;height:{% include 'stream/stream_height.html' %};overflow:scroll-y;">
	<div id="conversation{% if object.pk %}{{object.pk}}{% else %}welcome_chat{% endif %}" style="margin-bottom:9%;"></div>
</div>

