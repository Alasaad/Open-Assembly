<script type="text/javascript">

//WEBSOCKETS!
var socket = io.connect('http://{{settings.NODEJS_HOST}}:{{settings.NODEJS_PORT}}');
// on connection to server, ask for user's name with an anonymous callback
socket.on('connect', function(){
    // subscribe for real-time events!
    {% if request.user.is_authenticated %}
        socket.emit('subscribe', '{{request.user.username}}', '{{request.session.session_key}}');
    {% endif  %}
});
//when the client receives an event from nodejs
socket.on('updateUI', function(message) {
    var dict = JSON.parse(message)
    if(dict.type == 'vote'){
    }
    if($('#dynamic').css('top') == '-200px'){
        $('#dynamic').animate({'top':'32px'},500).delay(3000).animate({'top': '-200px'},500);
    }
    $('#dynamic').html('<h4>' + dict.message + '</h4><h3>' + dict.object + '</h3>');

});
// listener, whenever the server emits 'updatechat', this updates the chat body
socket.on('updatechat', function (username, data, object, sessionid, ifconnect) {
        if('{{request.session.session_key}}' == sessionid && username !== 'SERVER'){
            $('#conversation' + object).append('<b style="color:green;">'+username + ':</b> ' + data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").linkify() + '<br>');
        }
        else{
            $('#conversation' + object).append('<b>'+username + ':</b> ' + data.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").linkify() + '<br>');
        }
        eval('scrollBack' + object + '();');

        if($('#chatsounds'  + object).attr('class') == 'true'){
            if(!document.hasFocus() && !ifconnect){
                var delta  = new Date() - timestamp;
                if(delta > 5000 && delta){
                    EvalSound('audio1');
                    timestamp = new Date();
                }
            }
            if(ifconnect){
                EvalSound(ifconnect);
            }
        }
});

// listener, whenever the server emits 'updateusers', this updates the username list
socket.on('updateusers', function(data, object) {
    $('#users' + object).empty();
    $.each(data, function(key, value) {
        $('#users'  + object).append('<div>' + key + '</div>');
    });
});

</script>