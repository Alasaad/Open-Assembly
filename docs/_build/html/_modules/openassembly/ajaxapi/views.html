

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openassembly.ajaxapi.views &mdash; OA  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="top" title="OA  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">OA  documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openassembly.ajaxapi.views</h1><div class="highlight"><pre>
<span class="c"># Create your views here.</span>
<span class="kn">from</span> <span class="nn">pirate_consensus.models</span> <span class="kn">import</span> <span class="n">Consensus</span><span class="p">,</span> <span class="n">RatingVote</span><span class="p">,</span> <span class="n">UpDownVote</span><span class="p">,</span> <span class="n">VideoVote</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">pirate_sources.models</span> <span class="kn">import</span> <span class="n">URLSource</span>
<span class="kn">from</span> <span class="nn">tagging.models</span> <span class="kn">import</span> <span class="n">Tag</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">pirate_flags.models</span> <span class="kn">import</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">UserFlag</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">pirate_badges.models</span> <span class="kn">import</span> <span class="n">check_badges</span>
<span class="kn">from</span> <span class="nn">pirate_forum.models</span> <span class="kn">import</span> <span class="n">Edit</span>

<span class="kn">from</span> <span class="nn">pirate_topics.models</span> <span class="kn">import</span> <span class="n">Topic</span><span class="p">,</span> <span class="n">MyGroup</span><span class="p">,</span> <span class="n">del_group_tag</span><span class="p">,</span> <span class="n">add_group_tag</span>
<span class="kn">from</span> <span class="nn">pirate_messages.models</span> <span class="kn">import</span> <span class="n">Notification</span>

<span class="kn">from</span> <span class="nn">pirate_reputation.models</span> <span class="kn">import</span> <span class="n">ReputationEvent</span>

<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>

<span class="kn">from</span> <span class="nn">pirate_social.models</span> <span class="kn">import</span> <span class="n">Subscription</span>

<span class="kn">from</span> <span class="nn">oa_platform.models</span> <span class="kn">import</span> <span class="n">Platform</span><span class="p">,</span> <span class="n">PlatformDimension</span>
<span class="kn">from</span> <span class="nn">oa_cache.models</span> <span class="kn">import</span> <span class="n">interpret_hash</span><span class="p">,</span> <span class="n">build_hash</span>
<span class="kn">from</span> <span class="nn">oa_cache.views</span> <span class="kn">import</span> <span class="n">update_ranks</span>

<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>

<span class="kn">from</span> <span class="nn">pirate_core.middleware</span> <span class="kn">import</span> <span class="n">STR_KEY</span>
<span class="kn">from</span> <span class="nn">pirate_forum.models</span> <span class="kn">import</span> <span class="n">get_pretty_url</span>

<span class="kn">from</span> <span class="nn">pirate_ranking.models</span> <span class="kn">import</span> <span class="n">vote_created_callback</span>
<span class="kn">from</span> <span class="nn">tagging.models</span> <span class="kn">import</span> <span class="n">TaggedItem</span>
<span class="kn">from</span> <span class="nn">pirate_core.templatetags.tag_helpers</span> <span class="kn">import</span> <span class="n">get_recommended_tag_list</span><span class="p">,</span><span class="n">get_link_tag_list</span>

<span class="kn">from</span> <span class="nn">pirate_signals.models</span> <span class="kn">import</span> <span class="n">aso_rep_event</span><span class="p">,</span><span class="n">aso_rep_delete</span><span class="p">,</span><span class="n">relationship_event</span><span class="p">,</span><span class="n">delete_relationship_event</span><span class="p">,</span> <span class="n">update_agent</span>
<span class="kn">from</span> <span class="nn">pirate_reputation.models</span> <span class="kn">import</span> <span class="n">ReputationDimension</span>

<span class="kn">from</span> <span class="nn">oa_filmgenome.models</span> <span class="kn">import</span> <span class="n">FilmIdea</span>
<span class="kn">import</span> <span class="nn">search</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">diff_match_patch</span> <span class="kn">import</span> <span class="n">diff_match_patch</span>
<span class="kn">from</span> <span class="nn">search.views</span> <span class="kn">import</span> <span class="n">live_search_results</span>
<span class="kn">from</span> <span class="nn">markdown</span> <span class="kn">import</span> <span class="n">markdown</span>

<span class="kn">from</span> <span class="nn">oa_verification.models</span> <span class="kn">import</span> <span class="n">EmailVerification</span>


<div class="viewcode-block" id="live_search"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.live_search">[docs]</a><span class="k">def</span> <span class="nf">live_search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">live_search_results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">FilmIdea</span><span class="p">,</span>
     <span class="n">result_item_formatting</span><span class="o">=</span><span class="k">lambda</span> <span class="n">post</span><span class="p">:</span>
        <span class="p">{</span><span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="s">u&#39;&lt;div&gt;</span><span class="si">%s</span><span class="s">&lt;/div&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">summary</span><span class="p">),</span>
        <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">post</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span> <span class="p">})</span>

</div>
<div class="viewcode-block" id="search_posts"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.search_posts">[docs]</a><span class="k">def</span> <span class="nf">search_posts</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">&#39;query&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
        <span class="n">posts</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="n">FilmIdea</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/p/search_results&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;search_results.html&#39;</span><span class="p">,</span>
        <span class="p">{</span><span class="s">&#39;posts&#39;</span><span class="p">:</span> <span class="n">posts</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="add_support"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.add_support">[docs]</a><span class="k">def</span> <span class="nf">add_support</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;user&#39;</span><span class="p">]</span>
        <span class="n">object_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;subscribed&#39;</span><span class="p">]</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span>
        <span class="n">subscribed</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">object_pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">subscribee</span><span class="o">=</span><span class="n">subscribed</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="p">(</span><span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">subscribee</span><span class="o">=</span><span class="n">subscribed</span><span class="p">,</span>
                                    <span class="n">created_dt</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;redirect&#39;</span><span class="p">:</span> <span class="n">subscribed</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL:&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="remove_support"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.remove_support">[docs]</a><span class="k">def</span> <span class="nf">remove_support</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;user&#39;</span><span class="p">]</span>
        <span class="n">object_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;subscribed&#39;</span><span class="p">]</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span>
        <span class="n">subscribed</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">object_pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">Subscription</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subscriber</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                            <span class="n">subscribee</span><span class="o">=</span><span class="n">subscribed</span><span class="p">)</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>  <span class="s">&#39;redirect&#39;</span><span class="p">:</span> <span class="n">subscribed</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL:&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="change_hash_dim"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.change_hash_dim">[docs]</a><span class="k">def</span> <span class="nf">change_hash_dim</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">u&#39;hash&#39;</span><span class="p">]</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">u&#39;dim&#39;</span><span class="p">]</span>
        <span class="n">newkey</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">interpret_hash</span><span class="p">(</span><span class="n">hashed</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;DIM_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">build_hash</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;new_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;FAIL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="change_hash_ctype"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.change_hash_ctype">[docs]</a><span class="k">def</span> <span class="nf">change_hash_ctype</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;GET&#39;</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hashed</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">u&#39;hash&#39;</span><span class="p">]</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s">u&#39;dim&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">newkey</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">interpret_hash</span><span class="p">(</span><span class="n">hashed</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="s">&#39;PHASE_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctype</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">build_hash</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">newkey</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">interpret_hash</span><span class="p">(</span><span class="n">hashed</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;PHASE_KEY&#39;</span><span class="p">]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">build_hash</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;new_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;FAIL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="remove_group"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.remove_group">[docs]</a><span class="k">def</span> <span class="nf">remove_group</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;user&#39;</span><span class="p">]</span>
        <span class="n">topic_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;topic&#39;</span><span class="p">]</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">topic_pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">my</span> <span class="o">=</span> <span class="n">MyGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">my</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">topic</span><span class="o">.</span><span class="n">group_members</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">topic</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>  <span class="s">&#39;redirect&#39;</span><span class="p">:</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">(),</span> <span class="s">&#39;group&#39;</span><span class="p">:</span> <span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_name</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL:&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="add_group"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.add_group">[docs]</a><span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;user&#39;</span><span class="p">]</span>
        <span class="n">topic_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;topic&#39;</span><span class="p">]</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">topic_pk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">my</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">MyGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
            <span class="n">topic</span><span class="o">.</span><span class="n">group_members</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">topic</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_new</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;redirect&#39;</span><span class="p">:</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">(),</span> <span class="s">&#39;group&#39;</span><span class="p">:</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s">&#39;nav/mygroup.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;group&#39;</span><span class="p">:</span> <span class="n">my</span><span class="p">})}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL:&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="add_platform"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.add_platform">[docs]</a><span class="k">def</span> <span class="nf">add_platform</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;ctype&#39;</span><span class="p">]</span>
        <span class="n">object_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;object_pk&#39;</span><span class="p">]</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="n">PlatformDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">ctype</span><span class="p">)</span>

        <span class="n">pl</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                    <span class="n">dimension</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>
        <span class="c">#hehe</span>
        <span class="n">planck_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">planks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">planck_length</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">num_planks</span> <span class="ow">and</span> <span class="n">object_pk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pl</span><span class="o">.</span><span class="n">planks</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">planks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">object_pk</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">update_agent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;complete_perc&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">planck_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">num_planks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;%&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="remove_platform"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.remove_platform">[docs]</a><span class="k">def</span> <span class="nf">remove_platform</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;ctype&#39;</span><span class="p">]</span>
        <span class="n">object_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;object_pk&#39;</span><span class="p">]</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="n">PlatformDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">ctype</span><span class="p">)</span>

        <span class="n">pl</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                    <span class="n">dimension</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">planks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">object_pk</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">update_agent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">pl</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;complete_perc&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">planks</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">num_planks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;%&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="load_patch"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.load_patch">[docs]</a><span class="k">def</span> <span class="nf">load_patch</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">obj_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;obj_pk&#39;</span><span class="p">]</span>
        <span class="n">edit_num</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">u&#39;edit_num&#39;</span><span class="p">)</span>
        <span class="c">#text = request.POST.get(u&#39;text&#39;, &#39;&#39;)</span>
        <span class="n">patch_me</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">u&#39;patch&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">edit_num</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">edit_num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edit_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">edit_num</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">patch_me</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">edits</span> <span class="o">=</span> <span class="n">Edit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">obj_pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">edit</span> <span class="o">=</span> <span class="n">edits</span><span class="p">[</span><span class="n">edits</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">edit_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edits</span> <span class="o">=</span> <span class="n">Edit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">obj_pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">edit</span> <span class="o">=</span> <span class="n">edits</span><span class="p">[</span><span class="n">edits</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">edit_num</span><span class="p">)]</span>
        <span class="c"># diffs = []</span>
        <span class="c"># for edit in edits:</span>
        <span class="c">#     diffs.extend(json.loads(edit.edit_diff)[&#39;diff&#39;])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">edit</span><span class="o">.</span><span class="n">edit_diff</span><span class="p">)[</span><span class="s">&#39;diff&#39;</span><span class="p">]</span>
        <span class="c">#diff = diffs</span>
        <span class="c">#print text </span>
        <span class="c">#print &#39;cnt: &#39; + str(text.count(&#39;\n&#39;))</span>
        <span class="c">#text = html2text(text)</span>


        <span class="c">#get existing object text</span>
        <span class="c">#text = edit.content_object.description</span>

        <span class="n">mpl</span> <span class="o">=</span> <span class="n">diff_match_patch</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">patch_me</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">patch</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patch_make</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_diff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">new_diff</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">new_diff</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_diff</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">new_diff</span>

        <span class="c">#     patch = mpl.patch_make(new_diff)</span>
        <span class="c"># text = mpl.patch_apply(patch, text)</span>
        <span class="c"># print text [0]</span>
        <span class="c"># print &#39;cnt: &#39; + str(text[0].count(&#39;\n&#39;))</span>
        <span class="c"># print &#39;object: &#39; + str(edit.content_object.description.count(&#39;\n&#39;))</span>
        <span class="c">#ret_text = markdown(text[0])</span>
        <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="n">ret_text</span> <span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="c">#get next edit for purposes of going back</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">Edit</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">obj_pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">patch_me</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">previous</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">edit_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">previous</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">edit_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">pk</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">previous</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">edit_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">patch_me</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">previous</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">edit_num</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">edit_num</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">print</span> <span class="s">&#39;edit_num&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">edit_num</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;next&#39;</span><span class="p">:</span> <span class="n">previous</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="n">ret_text</span><span class="p">,</span> <span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;ctrl&#39;</span><span class="p">:</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s">&#39;etc/edits.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;object&#39;</span><span class="p">:</span> <span class="n">edit</span><span class="o">.</span><span class="n">content_object</span><span class="p">,</span>
                        <span class="s">&#39;edit_num&#39;</span><span class="p">:</span> <span class="n">edit_num</span> <span class="p">})}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="confirm"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.confirm">[docs]</a><span class="k">def</span> <span class="nf">confirm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">user_profile</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">EmailVerification</span><span class="p">,</span>
                                     <span class="n">activation_key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user_profile</span><span class="o">.</span><span class="n">key_expires</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/p/expired&quot;</span><span class="p">)</span>
    <span class="n">user_account</span> <span class="o">=</span> <span class="n">user_profile</span><span class="o">.</span><span class="n">user</span>
    <span class="n">user_account</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">user_account</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">update_agent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">user_account</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;user&quot;</span><span class="p">,</span>
                                <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">user_account</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&quot;/p/confirm&quot;</span><span class="p">)</span>


<span class="c">#HTML5 video voting functions</span></div>
<div class="viewcode-block" id="add_video_vote"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.add_video_vote">[docs]</a><span class="k">def</span> <span class="nf">add_video_vote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c">#needs to popup registration dialog instead</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;ERR1&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;ERR2&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}),</span>
         <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;&lt;QueryDict: {u&#39;data[vote][time]&#39;: [u&#39;12.582378387451172&#39;], u&#39;data[vote][duration]&#39;: [u&#39;207.4702911376953&#39;], u&#39;data[vote][video_id]&#39;: [u&#39;2&#39;], u&#39;data[vote][ip_address]&#39;: [u&#39;f528764d624db129b32c21fbca0cb8d6&#39;], u&#39;data[vote][keycode]&#39;: [u&#39;32&#39;]}&gt;&quot;&quot;&quot;</span>

        <span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data[vote][time]&#39;</span><span class="p">))</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data[vote][duration]&#39;</span><span class="p">)</span>
        <span class="n">v_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;data[vote][video_id]&#39;</span><span class="p">)</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bars&#39;</span><span class="p">)</span>

        <span class="c">#check to see if this user has already voted in this bucket</span>
        <span class="n">time_interval</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">bars</span><span class="p">))</span>
        <span class="n">old_votes</span> <span class="o">=</span> <span class="n">VideoVote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">video_id</span><span class="o">=</span><span class="n">v_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old_votes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">v</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">time_interval</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">time_interval</span> <span class="ow">and</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">v</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;ERR1&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;ERR2&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>


        <span class="n">new_vote</span> <span class="o">=</span> <span class="n">VideoVote</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span> <span class="n">video_id</span><span class="o">=</span><span class="n">v_id</span><span class="p">)</span>
        <span class="n">new_vote</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">}),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="update_video_votes"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.update_video_votes">[docs]</a><span class="k">def</span> <span class="nf">update_video_votes</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>

        <span class="n">video_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;video_id&#39;</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;duration&#39;</span><span class="p">))</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bars&#39;</span><span class="p">))</span>

        <span class="n">votes</span> <span class="o">=</span> <span class="n">VideoVote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">video_id</span><span class="o">=</span><span class="n">video_id</span><span class="p">)</span>
        <span class="n">barlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bars</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">vote</span> <span class="ow">in</span> <span class="n">votes</span><span class="p">:</span>
            <span class="c">#for each vote calculate bucket and add 1</span>
            <span class="n">barlist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vote</span><span class="o">.</span><span class="n">time</span> <span class="o">/</span> <span class="n">vote</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">bars</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">barlist</span><span class="p">)),</span>
                            <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>


<span class="c">#DELETE FUNCTIONS</span></div>
<div class="viewcode-block" id="delete_source"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.delete_source">[docs]</a><span class="k">def</span> <span class="nf">delete_source</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">object_id</span><span class="p">,</span> <span class="n">consensus_id</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">URLSource</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">object_id</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">consensus_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>


<span class="c">#DELETE OBJ</span>
<span class="c">#removes object from the database. There are orphan votes and comments still around.</span></div>
<div class="viewcode-block" id="delete_object"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.delete_object">[docs]</a><span class="k">def</span> <span class="nf">delete_object</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;user inactive or not logged in&#39;</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;content_type&#39;</span><span class="p">]</span>
        <span class="n">object_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;object_id&#39;</span><span class="p">]</span>
        <span class="n">contype</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">content_type</span><span class="p">)</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">object_id</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">children</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">contype</span><span class="o">.</span><span class="n">model_class</span><span class="p">()</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">object_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;object user not request user&#39;</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>
        <span class="c">#need to delete all the notifications about this</span>
        <span class="n">reps</span> <span class="o">=</span> <span class="n">ReputationEvent</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">Notification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">cons</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">notes</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="c"># now delete the object</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">user_cons</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="c">#delete all votes</span>
        <span class="n">uvote</span> <span class="o">=</span> <span class="n">UpDownVote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uvote</span><span class="p">:</span>
            <span class="n">aso_rep_delete</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vote&#39;</span><span class="p">),</span>
                                <span class="n">related_object</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">is_vote</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                                <span class="c"># register reputation for voting</span>
            <span class="n">user_cons</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">vote</span> <span class="o">=</span> <span class="n">RatingVote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">vote</span><span class="p">:</span>
            <span class="n">aso_rep_delete</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vote&#39;</span><span class="p">),</span>
                                <span class="n">related_object</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">is_vote</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                                <span class="c"># register reputation for voting</span>
            <span class="n">user_cons</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">cons</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">update_ranks</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c">#need to also delete comments...</span>
        <span class="c">#need to initiate update of this object</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;deleted&#39;</span><span class="p">}),</span>
                        <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="flagvote"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.flagvote">[docs]</a><span class="k">def</span> <span class="nf">flagvote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c">#needs to popup registration dialog instead</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
            <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">vote</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;vote&#39;</span><span class="p">])</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;pk&#39;</span><span class="p">])</span>
        <span class="n">flag_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;flag_type&#39;</span><span class="p">])</span>
        <span class="n">user_pk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span> <span class="o">!=</span> <span class="n">user_pk</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_pk</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">Flag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">,</span> <span class="n">flag_type</span><span class="o">=</span><span class="n">flag_type</span><span class="p">)</span>
        <span class="n">uflag</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">UserFlag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">vote</span><span class="p">)</span>
        <span class="n">votestr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">uflag</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">v</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">created</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">flag</span><span class="o">.</span><span class="n">votes</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">votes</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">votes</span>
                <span class="n">votestr</span> <span class="o">=</span> <span class="s">&#39;vote_up_flat&#39;</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">flag</span><span class="o">.</span><span class="n">counters</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">counters</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">counters</span>
                <span class="n">votestr</span> <span class="o">=</span> <span class="s">&#39;vote_down_flat&#39;</span>
            <span class="n">flag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">aso_rep_delete</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Flag&#39;</span><span class="p">),</span><span class="n">related_object</span><span class="o">=</span><span class="n">uflag</span><span class="p">)</span> <span class="c"># delete reputation is flag removed</span>
            <span class="n">uflag</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span> 
        <span class="k">elif</span> <span class="n">created</span><span class="p">:</span>
            <span class="n">uflag</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">flag</span><span class="o">.</span><span class="n">votes</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">votes</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">votes</span>
                <span class="n">votestr</span> <span class="o">=</span> <span class="s">&#39;vote_up_acti&#39;</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">flag</span><span class="o">.</span><span class="n">counters</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">counters</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">counters</span>
                <span class="n">votestr</span> <span class="o">=</span> <span class="s">&#39;vote_down_acti&#39;</span>
            <span class="n">uflag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">flag</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">check_badges</span><span class="p">(</span><span class="n">cons</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
            <span class="n">aso_rep_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Flag&#39;</span><span class="p">),</span><span class="n">related_object</span><span class="o">=</span><span class="n">uflag</span><span class="p">)</span> <span class="c"># register reputation for flag creation</span>
        <span class="n">imgsrc</span> <span class="o">=</span> <span class="s">&#39;/static/voteimgs/&#39;</span> <span class="o">+</span> <span class="n">votestr</span> <span class="o">+</span> <span class="s">&#39;.gif&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="s">&#39;count&#39;</span><span class="p">:</span><span class="n">count</span><span class="p">,</span> <span class="s">&#39;modes&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">(</span><span class="n">vote</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s">&#39;imgsrc&#39;</span><span class="p">:</span><span class="n">imgsrc</span><span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

<span class="c">#sets location in REQUEST dict to access google maps API</span></div>
<div class="viewcode-block" id="set_loc_by_ip"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.set_loc_by_ip">[docs]</a><span class="k">def</span> <span class="nf">set_loc_by_ip</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>     
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;city&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;city&#39;</span><span class="p">])</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;region&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;region&#39;</span><span class="p">])</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;country&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">}),</span> <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="add_tag"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.add_tag">[docs]</a><span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c">#needs to popup registration dialog instead</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}),</span> <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">obj_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;obj&#39;</span><span class="p">]</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;tag&#39;</span><span class="p">])</span>
        <span class="n">c_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;c_type&#39;</span><span class="p">])</span>
        <span class="n">app_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;app_type&#39;</span><span class="p">])</span>

        <span class="n">model_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="o">=</span><span class="n">app_type</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">c_type</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">model_type</span><span class="o">.</span><span class="n">get_object_for_this_type</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj_id</span><span class="p">)</span>

        <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="n">add_group_tag</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj_id</span><span class="p">,</span> <span class="n">c_type</span><span class="p">,</span> <span class="n">tag</span><span class="p">])</span>

        <span class="n">new_tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">relationship_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">new_tag</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">new_tag</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;linktaglist&#39;</span><span class="p">:</span> <span class="n">get_link_tag_list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">get_links</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;taglist&#39;</span><span class="p">:</span> <span class="n">get_recommended_tag_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">get_links</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="del_tag"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.del_tag">[docs]</a><span class="k">def</span> <span class="nf">del_tag</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c">#needs to popup registration dialog instead</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}),</span> <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">obj_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;obj&#39;</span><span class="p">]</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;tag&#39;</span><span class="p">])</span>
        <span class="n">c_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;c_type&#39;</span><span class="p">])</span>
        <span class="n">app_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;app_type&#39;</span><span class="p">])</span>

        <span class="n">model_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="o">=</span><span class="n">app_type</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">c_type</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">model_type</span><span class="o">.</span><span class="n">get_object_for_this_type</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj_id</span><span class="p">)</span>
        <span class="n">del_group_tag</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">obj_id</span><span class="p">,</span> <span class="n">c_type</span><span class="p">,</span> <span class="n">tag</span><span class="p">])</span>

        <span class="n">tagobj</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">taggedobj</span> <span class="o">=</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag_name</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">object_id</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">delete_relationship_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">tagobj</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">tagobj</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">taggedobj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;linktaglist&#39;</span><span class="p">:</span> <span class="n">get_link_tag_list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">get_links</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;taglist&#39;</span><span class="p">:</span> <span class="n">get_recommended_tag_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">get_links</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                    <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="spectrumvote"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.spectrumvote">[docs]</a><span class="k">def</span> <span class="nf">spectrumvote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is the POST function that is the django part of the Ajax/Javascript</span>
<span class="sd">    asynchronous voting function. The function receives a request from a</span>
<span class="sd">    consensus object, and creates/deletes a UpDownVote object as requested from</span>
<span class="sd">    the Javascript that calls this function.</span>

<span class="sd">    Returns: JSON object containing an updated count to modify vote totals in UI,</span>
<span class="sd">    and a image filename to modify graphical elements of the UI.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="c">#needs to popup registration dialog instead</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
        <span class="c">#need a better non-auth error here, interferes with view</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;pk&#39;</span><span class="p">]</span>
        <span class="n">vote_str</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;vote&#39;</span><span class="p">])</span>
        <span class="n">consensus</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">register</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>

        <span class="n">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">vote_str</span><span class="p">,</span> <span class="n">UpDownVote</span><span class="p">,</span> <span class="s">&#39;subjective&#39;</span><span class="p">,</span> <span class="n">register</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vote_str</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="s">&#39;Consent&#39;</span>
        <span class="k">elif</span> <span class="n">vote_str</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="s">&#39;Stand Aside&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vt</span> <span class="o">=</span> <span class="s">&#39;Dissent&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;vote_str&#39;</span><span class="p">:</span> <span class="n">vote_str</span><span class="p">,</span> <span class="s">&#39;votetype&#39;</span><span class="p">:</span> <span class="n">vt</span><span class="p">,</span> <span class="s">&#39;conspk&#39;</span><span class="p">:</span> <span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;reqpk&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                    <span class="s">&#39;equal&#39;</span><span class="p">:</span> <span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="starvote"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.starvote">[docs]</a><span class="k">def</span> <span class="nf">starvote</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This is the POST function that is the django part of the Ajax/Javascript</span>
<span class="sd">    asynchronous voting function. The function receives a request from a</span>
<span class="sd">    consensus object, and creates/deletes a UpDownVote object as requested from</span>
<span class="sd">    the Javascript that calls this function.</span>

<span class="sd">    Returns: JSON object containing an updated count to modify vote totals in UI,</span>
<span class="sd">    and a image filename to modify graphical elements of the UI.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span>  <span class="ow">or</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;pk&#39;</span><span class="p">]</span>
        <span class="n">vote_str</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">u&#39;vote&#39;</span><span class="p">])</span>

        <span class="n">consensus</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">register</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>

        <span class="n">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">vote_str</span><span class="p">,</span> <span class="n">RatingVote</span><span class="p">,</span> <span class="s">&#39;objective&#39;</span><span class="p">,</span> <span class="n">register</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;FAIL&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;vote_str&#39;</span><span class="p">:</span> <span class="n">vote_str</span><span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_ACCEPT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                                <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="vote"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.vote">[docs]</a><span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">vote</span><span class="p">,</span> <span class="n">votemodel</span><span class="p">,</span> <span class="n">vote_type_str</span><span class="p">,</span> <span class="n">register</span><span class="p">):</span>
    <span class="n">consensus</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">user_cons</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">cnt</span><span class="p">,</span>
                                <span class="n">object_pk</span><span class="o">=</span><span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                                <span class="n">parent_pk</span><span class="o">=</span><span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
                                <span class="n">vote_type</span><span class="o">=</span><span class="n">cnt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
        <span class="n">user_cons</span><span class="o">.</span><span class="n">intiate_vote_distributions</span><span class="p">()</span>
        <span class="n">user_cons</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">vote</span> <span class="o">==</span> <span class="o">-</span><span class="mi">99</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">votemodel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
        <span class="c"># register reputation for voting</span>
        <span class="k">if</span> <span class="n">register</span><span class="p">:</span>
            <span class="n">user_cons</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">vote</span><span class="p">)</span>
            <span class="n">aso_rep_delete</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                            <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vote&#39;</span><span class="p">),</span>
                            <span class="n">related_object</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">is_vote</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">consensus</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&#39;delete&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">vote</span><span class="p">)</span>

        <span class="n">update_agent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">user_cons</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;vote&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">vote_type_str</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
        <span class="n">st</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#TODO: there is an error happening here!</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">votemodel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">vote</span> <span class="o">!=</span> <span class="n">vote</span><span class="p">:</span>
                <span class="n">old_vote_pos</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">vote</span>
                <span class="n">old</span><span class="o">.</span><span class="n">vote</span> <span class="o">=</span> <span class="n">vote</span>
                <span class="n">old</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">register</span><span class="p">:</span>
                    <span class="n">user_cons</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="n">old_vote_pos</span><span class="p">)</span>
                <span class="n">vote_created_callback</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">consensus</span><span class="p">,</span> <span class="n">vote_type</span><span class="o">=</span><span class="n">vote</span><span class="p">)</span>
                <span class="n">consensus</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="n">old_vote</span><span class="o">=</span><span class="n">old_vote_pos</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">votemodel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">consensus</span><span class="p">,</span> <span class="n">vote</span><span class="o">=</span><span class="n">vote</span><span class="p">,</span> <span class="n">object_pk</span><span class="o">=</span><span class="n">pk</span><span class="p">,</span> <span class="n">parent_pk</span><span class="o">=</span><span class="n">consensus</span><span class="o">.</span><span class="n">parent_pk</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">check_badges</span><span class="p">(</span><span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">votemodel</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
            <span class="c"># register reputation for voting</span>
            <span class="n">vote_created_callback</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">consensus</span><span class="p">,</span> <span class="n">vote_type</span><span class="o">=</span><span class="n">vote</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">register</span><span class="p">:</span>
                <span class="n">aso_rep_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">consensus</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                <span class="n">initiator</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vote&#39;</span><span class="p">),</span>
                                <span class="n">related_object</span><span class="o">=</span><span class="n">st</span><span class="p">,</span> <span class="n">is_vote</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">user_cons</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&#39;register&#39;</span><span class="p">)</span>
            <span class="n">consensus</span><span class="o">.</span><span class="n">register_vote</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s">&#39;register&#39;</span><span class="p">)</span>
            <span class="n">update_agent</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">user_cons</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;vote&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">vote_type_str</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>


<span class="c">##########DEPRECATED!!!#############################</span>
<span class="c">#populates database with voting content for testing. I know it&#39;s ugly as hell, but I had this in it&#39;s own file and was having some import issues, thought</span>
<span class="c">#it best to just put it here until it is defunct and no longer needed. If anyone feels up for it, extracting this to a file wouldn&#39;t be difficult.</span></div>
<div class="viewcode-block" id="generate_vote_content"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.generate_vote_content">[docs]</a><span class="k">def</span> <span class="nf">generate_vote_content</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Help secure our Boarder by ending Marijuana Prohibition. Cartels make 60</span><span class="si">% o</span><span class="s">f there profit from Pot and are the single biggest threat to our Boarder. The only thing the Prohibition of Marijuana has done is made our enemies stronger from the BILLIONS in Pot profit that they use to fund even more harmful activities and crimes. Government has NO RIGHT to tell someone what they can and cant put into there bodies as long as it does not harm anyone else. Anyone with common sense knows Pot fits right into that category.&#39;</span><span class="p">,</span> <span class="s">&#39;American is not the welfare state for Mexico. We need to adopt Mexicos immigration law. We have an infestation of illegals because they have no respect for our country and refuse to obey our laws. Immigration numbers must be limited to a level that can be assimilated. Anchor babies and chain migration must stop. The current laws need to be enforced.&#39;</span><span class="p">,</span> <span class="s">&#39;All Americans shall maintain Habeas Corpus. They who can give up essential liberty to obtain a little temporary safety, deserve neither liberty nor safety. Benjamin Franklin&#39;</span><span class="p">,</span> <span class="s">&#39;Build entire fence along southern border, add more Border agents, add more ICE agents, impose heavy fines on employers using illegals, have all employers use E Verify, increase raids on employers, deport all illegals in our jails immediately, no more anchor babies, one parent needs to be US citizen, Deport all illegals over a 5 year period, do not allow any muslims to enter USA.&#39;</span><span class="p">,</span> <span class="s">&#39;Terrorists abroad are not as great a threat as leftists at home.&#39;</span><span class="p">,</span> <span class="s">&#39;I think that the party should take the advice of great conservative Barry Goldwater and let gay serve openly in the Armed Forces, as he said You dont have to be straight to shoot straight&#39;</span><span class="p">,</span> <span class="s">&#39;All US Citizens should know the US Constitution forwards &amp; backwards. We need to ensure that it is being taught extensively to our children. Also, all Government Officials, Law Enforcement Officers &amp; Military should be required to study it as they are required to swear an oath to uphold &amp; protect it...kind of hard to do when you dont know or understand what it says.&#39;</span><span class="p">,</span> <span class="s">&#39;The United States congress should only make laws that adhere to constitution. They should declare war when they go to war. They should protect our nation and only our nation. This includes closing down the more than 700 bases in over 150 countries. Bring the troops home, send them to border, and stop spending money to fund the military industrial complex. It is destroying our economy.&#39;</span><span class="p">,</span> <span class="s">&#39;If youve served honorably for 4 years, you should full scholarship to any University in this country if you qualify to get in. The wonky post 9/11 GI Bill doesnt cut it. ALL vets should be covered fully.&#39;</span><span class="p">,</span> <span class="s">&#39;Most military spending goes to expensive cold-war era hardware designed for nation-on-nation wars. This stuff doesnt make any sense in an era of guerilla war and terrorism. End these wasteful pork projects and redirect the money to our troops! They need better body armor, rifles, vehicles, and other equipment. We could save money AND have better train and equip our men in uniform. Boys before toys!&#39;</span><span class="p">,</span> <span class="s">&#39;Follow the lead of Israel and require every high school graduate to qualify and serve in one of the military branches for 2 years. Once enlisted, everyone gets a chance at a college education to further their military career with the requirement that one year of college = one more year of enlistment. After their honorable discharge, they become a member of ther Reserves and are required to remain available for callback to their active branch of service until the age of 40. During this time they keep their military issue gear and weapons and are allowed to upgrade when replacements come up to the active service.&#39;</span><span class="p">,</span> <span class="s">&#39;Abolish the IRS (70,320 pages and $304 billion a year compliance cost) which is nothing more than a greedy, institutionalized stealing agency. Its immoral and inhumane to steal peoples fruit of labor. End taxes at all levels of income for businesses and workers including payroll taxes. This will reduce the price of goods/services (govt induced inflation) and increase workers take home pay. Pass a law that govt can only tax at the point of consumption (no more than 15%) where it is clear, straight forward and visible to the consumer - no more hidden taxes built into the price like in gas, cigs, alcohol, etc. The poor and lower middles classes who use 90</span><span class="si">% o</span><span class="s">f govt services yet pay zero federal income taxes would pay their fair share and the rich would no longer seek tax shelters to hide their money since making money and succeeding is no longer punished by the federal govt. One national sales tax is a much fairer tax system that doesnt allow politicians to divide people into income groups for political gain. Its none of the govts business how much a person makes.&#39;</span><span class="p">,</span> <span class="s">&#39;Stop the outsourcing of jobs from America to other countries that do not pay taxes into the U.S. and stop the tax breaks that are given to these companies that are outsourcing. If there company is in the United States, hire people in the United States. That would create more revenue for the government as the American workers would pay taxes and the companies would be paying taxes to America as well.&#39;</span><span class="p">,</span> <span class="s">&#39;ENACT THE FAIR TAX and end the IRS. Not a flat tax, not some future adjustable tax reform, but the Fair Tax is the way to boost our economy while ending Congress ability to re-distribute wealth or manipulate behavior the way they have with the income-based tax system. Other benefits: it will attract businesses to locate themselves in the USA (increasing jobs), it collects taxes from EVERYONE here (including tourists and illegal aliens), and most importantly taxes arent hidden in your payroll check, they are obvious every time you purchase something.&#39;</span><span class="p">,</span> <span class="s">&#39;Balanced Budget, Eliminate Dept of Education, eliminate estate tax, cpa cap gain tax at 15%, Eliminate the IRS, institute a flat tax rate, reduce govt bureaucracy and spending, no more earmarks&#39;</span><span class="p">,</span> <span class="s">&#39;Transparency - American taxpayers deserve to see where their tax dollars are going, on the way into the legislative process and on the way out. This means ending the practice of rushing bills through Congress at the speed of light by requiring legislation be posted online for five days before it can be scheduled for a floor vote. This gives taxpayers the opportunity to read bills and offer feedback and potentially devastating legislation. We also must demand that ALL government expenditures, down to the line-item expense, be put online in a searchable, easily accessible format so taxpayers can track, dollar-for-dollar, where their hard-earned money is going. The only way to stop the spending is to keep representatives accountable - American taxpayers deserve the tools that will empower them to become good fiscal watchdogs of the state.&#39;</span><span class="p">,</span> <span class="s">&#39;Reduce the size of our military spending drastically. Its currently over 50</span><span class="si">% o</span><span class="s">f our national budget and doesnt need to be so gargantuan. Our carrier fleet alone is several times larger than the entire worlds fleets put together. If you cut that by itself youd save the American taxpayer quite a bit of money and even have some left over for infrastructure improvements, better schools and social programs that will make this nation stronger over all.&#39;</span><span class="p">]</span>
    <span class="n">topics</span> <span class="o">=</span> <span class="n">l</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;taxes&#39;</span><span class="p">,</span><span class="s">&#39;congress&#39;</span><span class="p">,</span><span class="s">&#39;jobs&#39;</span><span class="p">,</span><span class="s">&#39;freedom&#39;</span><span class="p">,</span><span class="s">&#39;constitution&#39;</span><span class="p">,</span><span class="s">&#39;budget&#39;</span><span class="p">,</span><span class="s">&#39;spending&#39;</span><span class="p">,</span><span class="s">&#39;abortion&#39;</span><span class="p">,</span><span class="s">&#39;immigration&#39;</span><span class="p">,</span><span class="s">&#39;tax&#39;</span><span class="p">,</span><span class="s">&#39;accountability&#39;</span><span class="p">,</span><span class="s">&#39;economy &#39;</span><span class="p">,</span><span class="s">&#39;government-reform &#39;</span><span class="p">,</span><span class="s">&#39;national-security &#39;</span><span class="p">,</span><span class="s">&#39;job &#39;</span><span class="p">,</span><span class="s">&#39;obama &#39;</span><span class="p">,</span><span class="s">&#39;education &#39;</span><span class="p">,</span><span class="s">&#39;religion &#39;</span><span class="p">,</span><span class="s">&#39;military &#39;</span><span class="p">,</span><span class="s">&#39;reform &#39;</span><span class="p">,</span><span class="s">&#39;welfare-reform &#39;</span><span class="p">,</span><span class="s">&#39;health &#39;</span><span class="p">,</span><span class="s">&#39;government &#39;</span><span class="p">,</span><span class="s">&#39;waste &#39;</span><span class="p">,</span><span class="s">&#39;corruption &#39;</span><span class="p">,</span><span class="s">&#39;debt &#39;</span><span class="p">,</span><span class="s">&#39;oil &#39;</span><span class="p">,</span><span class="s">&#39;health-care &#39;</span><span class="p">,</span><span class="s">&#39;unemployment &#39;</span><span class="p">,</span><span class="s">&#39;energy &#39;</span><span class="p">,</span><span class="s">&#39;illegal &#39;</span><span class="p">,</span><span class="s">&#39;bp &#39;</span><span class="p">,</span><span class="s">&#39;liberty &#39;</span><span class="p">,</span><span class="s">&#39;immigration &#39;</span><span class="p">,</span><span class="s">&#39;constituion &#39;</span><span class="p">,</span><span class="s">&#39;terrorism &#39;</span><span class="p">,</span><span class="s">&#39;marriage &#39;</span><span class="p">,</span><span class="s">&#39;deficit &#39;</span><span class="p">,</span><span class="s">&#39;voting &#39;</span><span class="p">,</span><span class="s">&#39;security &#39;</span><span class="p">,</span><span class="s">&#39;healthcare &#39;</span><span class="p">,</span><span class="s">&#39;tax-reform &#39;</span><span class="p">,</span><span class="s">&#39;regulation &#39;</span><span class="p">,</span><span class="s">&#39;marijuana &#39;</span><span class="p">,</span><span class="s">&#39;national &#39;</span><span class="p">,</span><span class="s">&#39;unions &#39;</span><span class="p">,</span><span class="s">&#39;medicare &#39;</span><span class="p">,</span><span class="s">&#39;environment &#39;</span><span class="p">,</span><span class="s">&#39;term &#39;</span><span class="p">,</span><span class="s">&#39;immigration-dude &#39;</span><span class="p">,</span><span class="s">&#39;citizenship &#39;</span><span class="p">,</span><span class="s">&#39;values &#39;</span><span class="p">,</span><span class="s">&#39;prosperity &#39;</span><span class="p">,</span><span class="s">&#39;job-creation &#39;</span><span class="p">,</span><span class="s">&#39;border-patrol&#39;</span><span class="p">,</span><span class="s">&#39;defense &#39;</span><span class="p">,</span><span class="s">&#39;term-limits &#39;</span><span class="p">,</span><span class="s">&#39;fiscal &#39;</span><span class="p">,</span><span class="s">&#39;border-control &#39;</span><span class="p">,</span><span class="s">&#39;tax &#39;</span><span class="p">,</span><span class="s">&#39;Government &#39;</span><span class="p">,</span><span class="s">&#39;life-health &#39;</span><span class="p">,</span><span class="s">&#39;irs &#39;</span><span class="p">,</span><span class="s">&#39;amendment &#39;</span><span class="p">,</span><span class="s">&#39;social-security &#39;</span><span class="p">,</span><span class="s">&#39;crime &#39;</span><span class="p">,</span><span class="s">&#39;illegal-immigration &#39;</span><span class="p">,</span><span class="s">&#39;Social &#39;</span><span class="p">,</span><span class="s">&#39;schools &#39;</span><span class="p">,</span><span class="s">&#39;social-secuirty &#39;</span><span class="p">,</span><span class="s">&#39;drugs &#39;</span><span class="p">,</span><span class="s">&#39;war &#39;</span><span class="p">,</span><span class="s">&#39;law &#39;</span><span class="p">,</span><span class="s">&#39;president &#39;</span><span class="p">,</span><span class="s">&#39;epa &#39;</span><span class="p">,</span><span class="s">&#39;senate &#39;</span><span class="p">,</span><span class="s">&#39;immigratiion &#39;</span><span class="p">,</span><span class="s">&#39;elections &#39;</span><span class="p">,</span><span class="s">&#39;website-problems &#39;</span><span class="p">,</span><span class="s">&#39;republicans &#39;</span><span class="p">,</span><span class="s">&#39;taxation &#39;</span><span class="p">,</span><span class="s">&#39;socialism &#39;</span><span class="p">,</span><span class="s">&#39;immagration &#39;</span><span class="p">,</span><span class="s">&#39;atr &#39;</span><span class="p">,</span><span class="s">&#39;bills &#39;</span><span class="p">,</span><span class="s">&#39;trade &#39;</span><span class="p">,</span><span class="s">&#39;money &#39;</span><span class="p">,</span><span class="s">&#39;liberty-and-freedom &#39;</span><span class="p">,</span><span class="s">&#39;patriotism &#39;</span><span class="p">,</span><span class="s">&#39;fiscal-accountability &#39;</span><span class="p">,</span><span class="s">&#39;fiscal-responsibility &#39;</span><span class="p">,</span><span class="s">&#39;budget &#39;</span><span class="p">,</span><span class="s">&#39;welfare &#39;</span><span class="p">,</span><span class="s">&#39;earmarks &#39;</span><span class="p">,</span><span class="s">&#39;flat-tax &#39;</span><span class="p">,</span><span class="s">&#39;god &#39;</span><span class="p">,</span><span class="s">&#39;censorship&#39;</span><span class="p">,</span><span class="s">&#39;obamacare &#39;</span><span class="p">,</span><span class="s">&#39;family-values&#39;</span><span class="p">,</span><span class="s">&#39;balanced&#39;</span><span class="p">]</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">users</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">issues</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">votes</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">ulist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u_pref</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">users</span><span class="p">):</span> <span class="c">#create 100 random users </span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">ulist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">tlist</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kn">from</span> <span class="nn">pirate_issues.models</span> <span class="kn">import</span> <span class="n">Topic</span><span class="p">,</span><span class="n">Issue</span>
    <span class="kn">from</span> <span class="nn">pirate_consensus.models</span> <span class="kn">import</span> <span class="n">Consensus</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">topics</span><span class="p">)):</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">topics</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">topic</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">tlist</span><span class="p">[</span><span class="n">topics</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">u_pref</span> <span class="o">=</span> <span class="p">[[</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">topics</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">users</span><span class="p">)]</span>
    <span class="n">u_mag</span> <span class="o">=</span> <span class="p">[[</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">topics</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">users</span><span class="p">)]</span>
    <span class="c">#now we have users and topics set up, start creating issues</span>
    <span class="n">issue_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">issues</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="s">&#39;Def&#39;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">Topic</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="n">tlist</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tlist</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
        <span class="n">iss</span> <span class="o">=</span> <span class="n">Issue</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)</span>
        <span class="n">iss</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">issue_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iss</span><span class="p">)</span>
        <span class="n">contype</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Issue</span><span class="p">)</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">Consensus</span><span class="p">(</span><span class="n">submit_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="n">content_type</span><span class="o">=</span><span class="n">contype</span><span class="p">,</span><span class="n">content_object</span><span class="o">=</span><span class="n">iss</span><span class="p">,</span><span class="n">object_pk</span><span class="o">=</span><span class="n">iss</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">cons</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="c">#now the groups of users vote on the, roulette wheel over preferences</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">votes</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">ulist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">roulette</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">u_pref</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">issue_list</span><span class="p">:</span>
            <span class="n">roulette</span> <span class="o">-=</span> <span class="n">u_pref</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">tlist</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">text</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">roulette</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vt</span> <span class="o">=</span> <span class="n">k</span>
                <span class="k">break</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">u_mag</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">tlist</span><span class="p">[</span><span class="n">vt</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">text</span><span class="p">]]</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">Consensus</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">new_vote</span> <span class="o">=</span> <span class="n">UpDownVote</span><span class="p">(</span><span class="n">vote_type</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span><span class="n">submit_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
            <span class="n">new_vote</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">6</span><span class="p">:</span>
            <span class="n">new_vote</span> <span class="o">=</span> <span class="n">UpDownVote</span><span class="p">(</span><span class="n">vote_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span><span class="n">submit_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
            <span class="n">new_vote</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_vote</span> <span class="o">=</span> <span class="n">UpDownVote</span><span class="p">(</span><span class="n">vote_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span><span class="n">submit_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="n">user</span><span class="o">=</span><span class="n">u</span><span class="p">)</span>
            <span class="n">new_vote</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">issue_list</span><span class="p">)</span>
        

        </div>
<div class="viewcode-block" id="setup_admin"><a class="viewcode-back" href="../../../openassembly.ajaxapi.html#openassembly.ajaxapi.views.setup_admin">[docs]</a><span class="k">def</span> <span class="nf">setup_admin</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">is_superuser</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_superuser</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="s">&quot;piratepolitics@gmail.com&quot;</span><span class="p">,</span><span class="s">&quot;password&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="s">&quot;Superuser with name &#39;admin&#39; and password &#39;password&#39; created.&quot;</span> 
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> superuser(s) already exist(s), including user with username &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> \
             <span class="o">%</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;This should not be reached.&quot;</span><span class="p">)</span>  </div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">OA  documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Frank Grove.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>