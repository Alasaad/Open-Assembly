

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openassembly.pirate_comments.templatetags.commenttags &mdash; ver1_0  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="ver1_0  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ver1_0  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openassembly.pirate_comments.templatetags.commenttags</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">template</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span>
<span class="kn">from</span> <span class="nn">pirate_comments.models</span> <span class="kn">import</span> <span class="n">Comment</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.middleware</span> <span class="kn">import</span> <span class="n">csrf</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">pirate_profile.models</span> <span class="kn">import</span> <span class="n">Profile</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">smart_str</span>
<span class="kn">from</span> <span class="nn">pirate_core.helpers</span> <span class="kn">import</span> <span class="n">clean_html</span>
<span class="kn">from</span> <span class="nn">pirate_consensus.models</span> <span class="kn">import</span> <span class="n">Consensus</span><span class="p">,</span> <span class="n">UpDownVote</span>
<span class="kn">from</span> <span class="nn">pirate_reputation.models</span> <span class="kn">import</span> <span class="n">ReputationDimension</span>
<span class="kn">from</span> <span class="nn">pirate_sources.models</span> <span class="kn">import</span> <span class="n">IMGSource</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">urlize</span>


<span class="kn">from</span> <span class="nn">markdown</span> <span class="kn">import</span> <span class="n">markdown</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">pirate_signals.models</span> <span class="kn">import</span> <span class="n">notification_send</span><span class="p">,</span> <span class="n">relationship_event</span><span class="p">,</span> <span class="n">aso_rep_event</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>

<span class="kn">from</span> <span class="nn">pirate_core.views</span> <span class="kn">import</span> <span class="n">HttpRedirectException</span><span class="p">,</span> <span class="n">namespace_get</span>


<span class="kn">from</span> <span class="nn">customtags.decorators</span> <span class="kn">import</span> <span class="n">block_decorator</span>
<span class="n">register</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">Library</span><span class="p">()</span>
<span class="n">block</span> <span class="o">=</span> <span class="n">block_decorator</span><span class="p">(</span><span class="n">register</span><span class="p">)</span>

<span class="n">get_namespace</span> <span class="o">=</span> <span class="n">namespace_get</span><span class="p">(</span><span class="s">&#39;pp_comment&#39;</span><span class="p">)</span>


<span class="nd">@block</span>
<div class="viewcode-block" id="pp_comment_count"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.pp_comment_count">[docs]</a><span class="k">def</span> <span class="nf">pp_comment_count</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_namespace</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">object_pk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">comments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">object_pk</span><span class="p">)))</span>
    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="DeleteForm"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.DeleteForm">[docs]</a><span class="k">class</span> <span class="nc">DeleteForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">form_id</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">HiddenInput</span><span class="p">(),</span> <span class="n">initial</span><span class="o">=</span><span class="s">&quot;pp_delete_form&quot;</span><span class="p">)</span>

</div>
<span class="nd">@block</span>
<div class="viewcode-block" id="pp_comment_delete"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.pp_comment_delete">[docs]</a><span class="k">def</span> <span class="nf">pp_comment_delete</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is rendered by the caching system when the user wants to delete a comment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_namespace</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">POST</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;object_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span>
    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">()</span> <span class="ow">and</span> <span class="n">user</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="n">POST</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;form_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;pp_delete_form&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">reply_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">is_leaf</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">is_deleted</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">DeleteForm</span><span class="p">()</span>

    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>

</div>
<span class="nd">@block</span>
<div class="viewcode-block" id="pp_comment_list_get"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.pp_comment_list_get">[docs]</a><span class="k">def</span> <span class="nf">pp_comment_list_get</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;we have to render the tree html here, because recursive includes are not allowed in django templates</span>
<span class="sd">    this could be more efficient with pre/post order tree traversal, but for now this suffices.</span>
<span class="sd">    mptt and treebeard both are not designed for GAE, need a tree traversal library for non-rel&quot;&quot;&quot;</span>

    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_namespace</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">object_pk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c">#needs request.user for reply submission</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">object_pk</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;pp_consensus_get tag requires that a consensus object be passed &quot;</span>
                             <span class="s">&quot;to it assigned to the &#39;object=&#39; argument, and that the str &quot;</span>
                             <span class="s">&quot;be assigned the string value &#39;consensus.&quot;</span><span class="p">)</span>

    <span class="n">comment_tree</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">object_pk</span><span class="p">,</span> <span class="n">is_root</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-submit_date&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
            <span class="n">comment_tree</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comment_tree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_children</span><span class="p">(</span><span class="n">object_pk</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>

    <span class="n">tree_html</span> <span class="o">=</span> <span class="n">render_to_comment_tree_html</span><span class="p">(</span><span class="n">comment_tree</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">tree_html</span> <span class="o">=</span> <span class="s">&quot;&lt;ul class=&#39;collapsible_comments&#39;&gt;&quot;</span> <span class="o">+</span> <span class="n">tree_html</span> <span class="o">+</span> <span class="s">&quot;&lt;/ul&gt;&quot;</span>
    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree_html</span>
    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;debug_comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment_tree</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="render_to_comment_tree_html"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.render_to_comment_tree_html">[docs]</a><span class="k">def</span> <span class="nf">render_to_comment_tree_html</span><span class="p">(</span><span class="n">comment_tree</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Comment tree in form:</span>
<span class="sd">        c_tree = [[Comment1, [Comment1_2, Comment1_3, Comment1_4]], Comment2, Comment 3]</span>
<span class="sd">    must be rendered as a &lt;ul&gt;...&lt;li&gt;&lt;ul&gt; ... &lt;li&gt;render_comment()&lt;/li&gt; ... &lt;/ul&gt; &lt;/li&gt; &lt;/ul&gt;&quot;&quot;&quot;</span>

    <span class="n">ret_html</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comment_tree</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">ret_html</span> <span class="o">+=</span> <span class="s">&#39;&lt;ul class=&quot;comment&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">render_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">comment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&lt;/ul&gt;&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ret_html</span> <span class="o">+=</span> <span class="s">&#39;&lt;ul class=&quot;comment&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">render_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;ul class=&quot;comment&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">render_to_comment_tree_html</span><span class="p">(</span><span class="n">comment</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&lt;/ul&gt;&lt;/ul&gt;&quot;</span>

    <span class="k">return</span> <span class="n">ret_html</span>


<span class="c">#TODO: FIXED</span></div>
<div class="viewcode-block" id="generate_time_string"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.generate_time_string">[docs]</a><span class="k">def</span> <span class="nf">generate_time_string</span><span class="p">(</span><span class="n">then</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>
    <span class="n">time_to</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">then</span><span class="p">)</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="n">time_to</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span>

    <span class="k">if</span> <span class="n">time_to</span><span class="o">.</span><span class="n">days</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_to</span><span class="o">.</span><span class="n">days</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; days ago&quot;</span>
    <span class="k">elif</span> <span class="n">hours</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_to</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_to</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; seconds ago&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_to</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; minutes ago&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_to</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; hours ago&quot;</span>
    <span class="k">return</span> <span class="s">&quot; said &quot;</span> <span class="o">+</span> <span class="n">ret</span>

</div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;a href=&quot;#&quot; class=&quot;avatar&quot;&gt;&lt;img src=&quot;/static/img/avatar_20x18.jpg&quot; alt=&quot;username&quot;&gt;&lt;/a&gt;</span>
<span class="sd">    &lt;div&gt;</span>
<span class="sd">        &lt;a href=&quot;#&quot; class=&quot;author&quot;&gt;Happily_siLent&lt;/a&gt; &lt;span class=&quot;meta&quot;&gt;at 12:11p on 1/1/11&lt;/span&gt;</span>
<span class="sd">        &lt;p&gt;</span>
<span class="sd">            Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry&#39;s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.</span>
<span class="sd">        &lt;/p&gt;</span>
<span class="sd">        &lt;ul class=&quot;comment_links&quot;&gt;</span>
<span class="sd">            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;Reply&lt;/a&gt;&lt;/li&gt;</span>
<span class="sd">            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;Permalink&lt;/a&gt;&lt;/li&gt;</span>
<span class="sd">        &lt;/ul&gt;</span>
<span class="sd">    &lt;/div&gt;</span>

<span class="sd">try:</span>
<span class="sd">    img = IMGSource.objects.get(user=user,current=True)</span>
<span class="sd">    ts = img.url + &#39;=s20-c&#39;</span>
<span class="sd">except:</span>
<span class="sd">    ts = &#39;/static/img/avatar_20x18.jpg&#39;</span>

<span class="sd">html = &quot;&lt;a href=&#39;/user_profile.html&quot; + &quot;?_t=&quot; + str(content_type.pk) + &quot;&amp;_o=&quot; + str(comment_obj.user.pk) + &quot;&#39;&quot; + &#39; class=&quot;avatar&quot;&gt;&lt;img src=&quot;&#39; + ts + &#39;&quot; alt=&quot;&#39; + str(user.username) + &#39;&quot;&gt;&lt;/a&gt;&#39;</span>
<span class="sd">html += &quot;&lt;div id=&#39;comment&quot; + str(comment_obj.id) + &quot;&#39;&gt;&quot;</span>
<span class="sd">html += &quot;&lt;a href=&#39;/user_profile.html&quot; + &quot;?_t=&quot; + str(content_type.pk) + &quot;&amp;_o=&quot; + str(comment_obj.user.pk) + &quot;&#39;&quot; + &#39; class=&quot;author&quot;&gt;&#39; + str(user.username) + &#39;&lt;/a&gt; &lt;span class=&quot;meta&quot;&gt;&#39; + generate_time_string(comment_obj.submit_date, datetime.datetime.now()) +  &#39;&lt;/span&gt;&lt;p&gt;&#39;</span>
<span class="sd">html += smart_str(comment_obj.text, encoding=&#39;utf-8&#39;, strings_only=False, errors=&#39;strict&#39;) + &#39;&lt;/p&gt;&#39;</span>
<span class="sd">html += &#39;&lt;ul class=&quot;comment_links&quot;&gt;&#39; + &#39;&lt;li&gt;&#39; + &quot;&lt;a href=&#39;javascript:;&#39; onmousedown=&quot; + &quot;&#39;toggleSlide(&quot; + &#39;&quot;add_reply&#39; + str(comment_obj.id) + &#39;&quot;&#39; + &quot;);&#39;&gt;reply&lt;/a&gt;&quot; + &#39;&lt;/li&gt;&#39; + &#39;&lt;li&gt;&#39; + &quot;&lt;a href=&#39;/&quot; + path + &quot;&#39;&gt;permalink&lt;/a&gt;&quot; + &#39;&lt;/li&gt;&#39;</span>
<span class="sd">html += &#39;&lt;/ul&gt;&#39;</span>
<span class="sd">html += &quot;&lt;div id=&#39;add_reply&quot; + str(comment_obj.id) + &quot;&#39; style=&#39;display:none; overflow:hidden; height:250px;&#39;&gt;&lt;form id=&#39;add_reply_form&quot; + str(comment_obj.id) +&quot;&#39; method=&#39;post&#39; action=&#39;&#39;&gt;&lt;div style=&#39;display:none&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;csrfmiddlewaretoken&#39; value=&#39;&quot; + str(csrf.get_token(request)) + &quot;&#39; /&gt;&lt;input id=&#39;reply_to_object&#39; type=&#39;hidden&#39; name=&#39;reply_to_object&#39; value=&#39;&quot; + str(comment_obj.id)+ &quot;&#39;/&gt;&lt;/div&gt;&quot; + str(form.as_p()) + &quot;&lt;input type=&#39;submit&#39; class=&#39;button green&#39; value=&#39;Submit Comment&#39;&gt;&lt;/form&gt;&lt;/div&gt;&lt;/div&gt;&quot;</span>
<span class="sd">html+= &quot;&lt;/div&gt;&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="render_comment"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.render_comment">[docs]</a><span class="k">def</span> <span class="nf">render_comment</span><span class="p">(</span><span class="n">comment_obj</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="c">#ok this is as ugly as it gets, but there&#39;s little other ways to generate this html that I am aware of</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;detail.html?_t=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&amp;_o=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">object_pk</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ReplyForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;is_root&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;is_leaf&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">comment_obj</span><span class="o">.</span><span class="n">content_type</span><span class="p">,</span>
            <span class="s">&#39;object_pk&#39;</span><span class="p">:</span> <span class="n">comment_obj</span><span class="o">.</span><span class="n">object_pk</span><span class="p">,</span> <span class="s">&#39;reply_to&#39;</span><span class="p">:</span> <span class="n">comment_obj</span><span class="p">,</span> <span class="s">&#39;submit_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">})</span>

    <span class="sd">&quot;&quot;&quot;returns the relevant html for a single atomic comment given the comment object&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">IMGSource</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">url</span> <span class="o">+</span> <span class="s">&#39;=s20-c&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="s">&#39;/static/img/avatar_20x18.jpg&#39;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="s">&quot;&lt;a href=&#39;/user_profile.html&quot;</span> <span class="o">+</span> <span class="s">&quot;?_t=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_type</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&amp;_o=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s">&#39; class=&quot;avatar&quot;&gt;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="n">ts</span> <span class="o">+</span> <span class="s">&#39;&quot; alt=&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&gt;&lt;/a&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;li id=&#39;comment&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;a href=&#39;/user_profile.html&quot;</span> <span class="o">+</span> <span class="s">&quot;?_t=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">content_type</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&amp;_o=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s">&#39; class=&quot;author&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;/a&gt; &lt;span class=&quot;meta&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">generate_time_string</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">submit_date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span>  <span class="s">&#39;&lt;/span&gt;&lt;p&gt;&#39;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">safe_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="n">smart_str</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">strings_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;strict&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&lt;/p&gt;&#39;</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;ul class=&quot;comment_links&quot;&gt;&#39;</span> <span class="o">+</span> <span class="s">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;a href=&#39;javascript:;&#39; onmousedown=&quot;</span> <span class="o">+</span> <span class="s">&quot;&#39;toggleSlide(&quot;</span> <span class="o">+</span> <span class="s">&#39;&quot;add_reply&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s">&quot;);&#39;&gt;reply&lt;/a&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;/li&gt;&#39;</span> <span class="o">+</span> <span class="s">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;a href=&#39;/&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&gt;permalink&lt;/a&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;/li&gt;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;ul class=&quot;comment_links&quot;&gt;&#39;</span> <span class="o">+</span> <span class="s">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;a href=&#39;/&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&quot;&amp;_i=s&#39;&gt;reply&lt;/a&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;/li&gt;&#39;</span> <span class="o">+</span> <span class="s">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;a href=&#39;/&quot;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&quot;&amp;_c=comment&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39;&gt;permalink&lt;/a&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;/li&gt;&#39;</span>
    <span class="k">if</span> <span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;a href=&#39;javascript:;&#39; onmousedown=&quot;</span> <span class="o">+</span> <span class="s">&quot;&#39;toggleSlide(&quot;</span> <span class="o">+</span> <span class="s">&#39;&quot;edit_reply&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s">&quot;);&#39;&gt;edit&lt;/a&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;/li&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;/ul&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;p&gt;&#39;</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;div class=&#39;reply_comment&#39; id=&#39;add_reply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39; style=&#39;display:none; overflow:hidden; height:290px;width:100%;&#39;&gt;&lt;form id=&#39;add_reply_form&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&#39; method=&#39;post&#39; action=&#39;&#39;&gt;&lt;div style=&#39;display:none&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;csrfmiddlewaretoken&#39; value=&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csrftoken&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39; /&gt;&lt;input id=&#39;reply_to_object&#39; type=&#39;hidden&#39; name=&#39;reply_to_object&#39; value=&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;&#39;/&gt;&lt;/div&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">as_p</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;&lt;input type=&#39;submit&#39; class=&#39;button&#39; value=&#39;Submit&#39;&gt;&lt;/form&gt;&lt;/div&gt;&quot;</span>
    <span class="k">if</span> <span class="n">comment_obj</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">editform</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">comment_obj</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;div class=&#39;reply_comment&#39; id=&#39;edit_reply&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;&#39; style=&#39;display:none; overflow:hidden; height:290px;width:100%;&#39;&gt;&lt;form id=&#39;add_reply_form&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span><span class="s">&quot;&#39; method=&#39;post&#39; action=&#39;&#39;&gt;&lt;div style=&#39;display:none&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;csrfmiddlewaretoken&#39; value=&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csrftoken&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39; /&gt;&lt;input id=&#39;edit_object&#39; type=&#39;hidden&#39; name=&#39;edit_object&#39; value=&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;&#39;/&gt;&quot;</span> <span class="o">+</span> <span class="s">&#39;&lt;input type=&quot;hidden&quot; name=&quot;form_id&quot; value=&quot;pp_comment_form&#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">comment_obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; id=&quot;id_form_id&quot;/&gt;&#39;</span> <span class="o">+</span> <span class="s">&quot;&lt;/div&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">editform</span><span class="o">.</span><span class="n">as_p</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;&lt;input type=&#39;submit&#39; class=&#39;button&#39; value=&#39;Submit&#39;&gt;&lt;/form&gt;&lt;/div&gt;&quot;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&#39;&lt;/p&gt;&#39;</span>
    <span class="n">html</span> <span class="o">+=</span> <span class="s">&quot;&lt;/li&gt;&quot;</span>
    <span class="k">return</span> <span class="n">urlize</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">trim_url_limit</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nofollow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#return &quot;&lt;div id=&#39;comment&quot; + str(comment_obj.id) + &quot;&#39;&gt; &lt;div class=&#39;comment_user&#39;&gt; &lt;a href=&#39;/user_profile.html&quot; + &quot;?_t=&quot; + str(content_type.pk) + &quot;&amp;_o=&quot; + str(comment_obj.user.pk) + &quot;&#39;&gt;&quot; + str(comment_obj.user.username)+ &quot;&lt;/a&gt;&quot; + generate_time_string(comment_obj.submit_date, datetime.datetime.now()) + &quot;:&lt;/div&gt;&lt;div&gt;&quot; + smart_str(comment_obj.text, encoding=&#39;utf-8&#39;, strings_only=False, errors=&#39;strict&#39;) +&quot;&lt;/div&gt;&lt;div class=&#39;comment_reply&#39;&gt;&quot; + &quot; &lt;a href=&#39;javascript:;&#39; onmousedown=&quot; + &quot;&#39;toggleSlide(&quot; + &#39;&quot;add_reply&#39; + str(comment_obj.id) + &#39;&quot;&#39; + &quot;);&#39;&gt;reply&lt;/a&gt; &lt;a href=&#39;/&quot; + path + &quot;&#39;&gt;permalink&lt;/a&gt;&lt;div id=&#39;add_reply&quot; + str(comment_obj.id) + &quot;&#39; style=&#39;display:none; overflow:hidden; height:250px;&#39;&gt;&lt;form id=&#39;add_reply_form&quot; + str(comment_obj.id) +&quot;&#39; method=&#39;post&#39; action=&#39;&#39;&gt;&lt;div style=&#39;display:none&#39;&gt;&lt;input type=&#39;hidden&#39; name=&#39;csrfmiddlewaretoken&#39; value=&#39;&quot; + str(csrf.get_token(request)) + &quot;&#39; /&gt;&lt;input id=&#39;reply_to_object&#39; type=&#39;hidden&#39; name=&#39;reply_to_object&#39; value=&#39;&quot; + str(comment_obj.id)+ &quot;&#39;/&gt;&lt;/div&gt;&quot; + str(form.as_p()) + &quot;&lt;input type=&#39;submit&#39; class=&#39;button green&#39; value=&#39;Submit Comment&#39;&gt;&lt;/form&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&quot;</span>

</div>
<div class="viewcode-block" id="get_children"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.get_children">[docs]</a><span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="n">object_pk</span><span class="p">,</span> <span class="n">cur_comment</span><span class="p">):</span>
    <span class="n">get_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="n">object_pk</span><span class="p">,</span> <span class="n">is_root</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="n">cur_comment</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
            <span class="n">get_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_children</span><span class="p">(</span><span class="n">object_pk</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">cur_comment</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">comments</span><span class="p">)),</span> <span class="n">get_list</span><span class="p">]</span>

</div>
<span class="nd">@block</span>
<div class="viewcode-block" id="pp_comment_form"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.pp_comment_form">[docs]</a><span class="k">def</span> <span class="nf">pp_comment_form</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This block tag can create or process forms either to create or to modify issues.</span>
<span class="sd">    Usage is as follows:</span>

<span class="sd">    {% pp_comment_form POST=request.POST object=request.object user=request.user %}</span>
<span class="sd">       Do stuff with {{ pp-comment.form }}.</span>
<span class="sd">    {% endpp_comment_form %}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_namespace</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">POST</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">reply_to</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;edit&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">POST</span> <span class="ow">and</span> <span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;form_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;pp_edit_form&quot;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">comment</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">clean_html</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">])</span>
                <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>

        <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;object_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">pk</span>
        <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>

    <span class="k">elif</span> <span class="n">POST</span> <span class="ow">and</span> <span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;form_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;pp_comment_form&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">POST</span><span class="p">)</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">newcomment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">c_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">reply_to</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">c_type</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">object_pk</span> <span class="o">=</span> <span class="n">reply_to</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">clean_html</span><span class="p">(</span><span class="n">newcomment</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">is_leaf</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">submit_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">is_root</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">newcomment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;object_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcomment</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">newcomment</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>
                <span class="n">cvt</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">UpDownVote</span><span class="p">)</span>
                <span class="c">#cons, is_new = Consensus.objects.get_or_create(content_type=c_type,</span>
                <span class="c">#                    object_pk=newcomment.pk,</span>
                <span class="c">#                    vote_type=cvt,</span>
                <span class="c">#                    parent_pk=reply_to.pk)</span>
                <span class="n">notification_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">content_object</span><span class="p">)</span>
                <span class="n">relationship_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">content_object</span><span class="p">)</span>
                <span class="n">aso_rep_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">initiator</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">),</span> <span class="n">related_object</span><span class="o">=</span><span class="n">newcomment</span><span class="p">)</span>
            <span class="c">#raise HttpRedirectException(HttpResponseRedirect(newcomment.get_absolute_url()))</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span>

    <span class="k">elif</span> <span class="n">POST</span> <span class="ow">and</span> <span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;form_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;pp_reply_form&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">ReplyForm</span><span class="p">(</span><span class="n">POST</span><span class="p">)</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">ReplyForm</span><span class="p">(</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">newcomment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">reply_to</span><span class="o">.</span><span class="n">content_type</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">object_pk</span> <span class="o">=</span> <span class="n">reply_to</span><span class="o">.</span><span class="n">object_pk</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">reply_to</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">is_leaf</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">clean_html</span><span class="p">(</span><span class="n">newcomment</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">is_leaf</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">is_root</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">submit_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">newcomment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;object_pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newcomment</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">newcomment</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span>
            <span class="n">cvt</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">UpDownVote</span><span class="p">)</span>
            <span class="c">#cons, is_new = Consensus.objects.get_or_create(content_type=reply_to.content_type,</span>
            <span class="c">#                        object_pk=newcomment.pk,</span>
            <span class="c">#                        vote_type=cvt,</span>
            <span class="c">#                        parent_pk=reply_to.object_pk)</span>
            <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c">#if comment is new and not editted</span>
                <span class="n">notification_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span><span class="p">)</span>
                <span class="n">relationship_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">newcomment</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span><span class="p">)</span>
                <span class="n">aso_rep_event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">event_score</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">reply_to</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                    <span class="n">initiator</span><span class="o">=</span><span class="n">newcomment</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">ReputationDimension</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;comment&quot;</span><span class="p">),</span> <span class="n">related_object</span><span class="o">=</span><span class="n">newcomment</span><span class="p">)</span>
        <span class="c">#raise HttpRedirectException(HttpResponseRedirect(newcomment.get_absolute_url()))</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span> <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>

    <span class="n">namespace</span><span class="p">[</span><span class="s">&#39;form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">form</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="CommentForm"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.CommentForm">[docs]</a><span class="k">class</span> <span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This form is used to allow creation and modification of comment objects.  </span>
<span class="sd">    It extends FormMixin in order to provide a create() class method, which</span>
<span class="sd">    is used to process POST, path, and object variables in a consistant way,</span>
<span class="sd">    and in order to automatically provide the form with a form_id.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="CommentForm.save"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.CommentForm.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">new_comment</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CommentForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_comment</span>
</div>
<div class="viewcode-block" id="CommentForm.Meta"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.CommentForm.Meta">[docs]</a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span><span class="s">&#39;object_pk&#39;</span><span class="p">,</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span><span class="s">&#39;reply_to&#39;</span><span class="p">,</span><span class="s">&#39;submit_date&#39;</span><span class="p">,</span> <span class="s">&#39;is_leaf&#39;</span><span class="p">,</span><span class="s">&#39;is_root&#39;</span><span class="p">,</span> <span class="s">&#39;content_object&#39;</span><span class="p">)</span>
    <span class="c">#need to grab user from authenticatio</span>
    <span class="c">#form_id = forms.CharField(widget=forms.HiddenInput(), initial=&quot;pp_comment_form&quot;)</span></div>
    <span class="n">text</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ReplyForm"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.ReplyForm">[docs]</a><span class="k">class</span> <span class="nc">ReplyForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This form is used to allow creation and modification of comment objects.  </span>
<span class="sd">    It extends FormMixin in order to provide a create() class method, which</span>
<span class="sd">    is used to process POST, path, and object variables in a consistant way,</span>
<span class="sd">    and in order to automatically provide the form with a form_id.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="ReplyForm.save"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.ReplyForm.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">new_comment</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ReplyForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="n">commit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_comment</span>
</div>
<div class="viewcode-block" id="ReplyForm.Meta"><a class="viewcode-back" href="../../../../openassembly.pirate_comments.templatetags.html#openassembly.pirate_comments.templatetags.commenttags.ReplyForm.Meta">[docs]</a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span><span class="s">&#39;object_pk&#39;</span><span class="p">,</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span><span class="s">&#39;reply_to&#39;</span><span class="p">,</span><span class="s">&#39;submit_date&#39;</span><span class="p">,</span> <span class="s">&#39;is_leaf&#39;</span><span class="p">,</span><span class="s">&#39;is_root&#39;</span><span class="p">,</span> <span class="s">&#39;content_object&#39;</span><span class="p">)</span>
    <span class="c">#need to grab user from authenticatio</span></div>
    <span class="n">form_id</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">HiddenInput</span><span class="p">(),</span> <span class="n">initial</span><span class="o">=</span><span class="s">&quot;pp_reply_form&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">ver1_0  documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Author.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>